name: Generate Conference ICS Files

on:
  schedule:
    # æ¯å¤© UTC æ—¶é—´ 06:00 è¿è¡Œ (åŒ—äº¬æ—¶é—´ 14:00)
    - cron: '0 6 * * *'
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  update-and-generate:
    runs-on: ubuntu-latest
    
    permissions:
      contents: write
      pages: write
      id-token: write
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        # å¦‚æœä½ æœ‰ package-lock.jsonï¼Œè¿™é‡Œä¼šè‡ªåŠ¨å¤„ç†ç¼“å­˜
        cache: 'npm' 
        
    - name: Install dependencies
      # çˆ¬è™«è„šæœ¬é€šå¸¸éœ€è¦ç¬¬ä¸‰æ–¹åº“ (å¦‚ axios, cheerio ç­‰)ï¼Œå¿…é¡»å…ˆå®‰è£…
      run: |
        if [ -f package.json ]; then
          npm ci
        fi

    - name: Fetch Conference Data (Weekly)
      # é€»è¾‘ï¼šå¦‚æœæ˜¯æ‰‹åŠ¨è§¦å‘ OR ä»Šå¤©æ˜¯å‘¨ä¸€ (date +%u = 1)ï¼Œåˆ™æ‰§è¡Œçˆ¬è™«
      run: |
        # è·å–å½“å‰æ˜¯å‘¨å‡  (1=å‘¨ä¸€, 7=å‘¨æ—¥)
        DOW=$(date +%u)
        
        if [ "$DOW" -eq 1 ] || [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
          echo "ğŸš€ It is Monday (or manual trigger). Running fetch script..."
          node fetch_conference_data.js
        else
          echo "ğŸ’¤ Not Monday. Skipping fetch script."
        fi

    - name: Generate ICS files
      # å§‹ç»ˆè¿è¡Œï¼ŒåŸºäº source/ ä¸‹çš„æ•°æ®ï¼ˆå¯èƒ½æ˜¯åˆšçˆ¬ä¸‹æ¥çš„ï¼Œä¹Ÿå¯èƒ½æ˜¯æ—§çš„ï¼‰ç”Ÿæˆæœ€æ–°çš„ ICS
      run: node generate-ics.js
      
    - name: Prepare GitHub Pages content
      run: |
        mkdir -p ./_site
        cp index.html ./_site/
        cp styles.css ./_site/
        cp script.js ./_site/
        cp -r source ./_site/
        cp -r ics ./_site/
      
    - name: Setup Pages
      uses: actions/configure-pages@v4
      
    - name: Upload artifact
      uses: actions/upload-pages-artifact@v3
      with:
        path: './_site'
    
    - name: Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v4
      
    - name: Commit and push if changes
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        # ä½ çš„çˆ¬è™«è„šæœ¬ä¿®æ”¹äº† sourceï¼Œç”Ÿæˆè„šæœ¬ä¿®æ”¹äº† icsï¼Œè¿™é‡Œä¸€èµ·æäº¤
        git add ics/
        git add source/ 
        
        # æ£€æŸ¥æ˜¯å¦æœ‰å˜åŠ¨
        if ! git diff --staged --quiet; then
          # åŠ¨æ€ç”Ÿæˆ Commit ä¿¡æ¯ï¼ŒåŒºåˆ†æ˜¯å…¨é‡æ›´æ–°è¿˜æ˜¯ä»…æ—¥å†æ›´æ–°
          if [ "$(date +%u)" -eq 1 ]; then
             MSG="ğŸš€ Weekly Update: Fetched new data & generated ICS"
          else
             MSG="ğŸ—“ï¸ Daily Update: Regenerated ICS files"
          fi
          
          git commit -m "$MSG - $(date -u +'%Y-%m-%d')"
          git push
        else
          echo "No changes to commit"
        fi